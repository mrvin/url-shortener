services:
    url-shortener-prod:
        profiles: ['prod']
        image: ghcr.io/mrvin/url-shortener:v1.0.0
#        build:
#         context: ../
#         dockerfile: Dockerfile
#         target: prod
        ports:
         - "8080"
        env_file:
         - ../configs/url-shortener.env
        depends_on:
          redis:
            condition: service_healthy
          migrate:
            condition: service_completed_successfully
        healthcheck:
          test: ["CMD", "/bin/httpscheck", "http://url-shortener-prod:8080/api/health"]
          interval: 1s
        volumes:
         - ${HOME}/volumes_docker/url-shortener/log:/var/log/url-shortener/
         - ../certs:/app/certs/

    url-shortener-dev:
        profiles: ['dev']
        build:
         context: ../
         dockerfile: Dockerfile
         target: dev
        ports:
         - "8080"
        env_file:
         - ../configs/url-shortener.env
        depends_on:
          redis:
            condition: service_healthy
          migrate:
            condition: service_completed_successfully
        healthcheck:
          test: ["CMD", "/bin/httpscheck", "http://url-shortener-dev:8080/api/health"]
          interval: 1s
        volumes:
         - ${HOME}/volumes_docker/url-shortener/log:/var/log/url-shortener/
         - ../certs:/app/certs/

    migrate:
        image: migrate/migrate:v4.19.1
        command: ["-path", "/migrations", "-database",  "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}?sslmode=disable", "up"]
        depends_on:
          postgres:
            condition: service_healthy
        volumes:
         - ./../migrations:/migrations

    # Create service with PostgreSQL.
    postgres:
        image: postgres:18.1-alpine3.23
        ports:
         - "5432"
        env_file:
         - ../configs/url-shortener.env
        healthcheck:
          test: ["CMD", "pg_isready", "-q", "-d", "${POSTGRES_DB}", "-U", "${POSTGRES_USER}"]
          interval: 1s
        volumes:
         - ${HOME}/volumes_docker/url-shortener/postgres-data:/var/lib/postgresql/data

    # Create service with Redis.
    redis:
        image: redis:8.2-alpine
        ports:
         - "6379"
        healthcheck:
          test: ["CMD", "redis-cli", "ping"]
          interval: 1s
        volumes:
         - "${HOME}/volumes_docker/url-shortener/data:/data/"

    # Create service with Redis gui.
    redis-gui:
        profiles: ['dev']
        image: redis/redisinsight:3.0
        ports:
         - "5540:5540"
        depends_on:
          redis:
            condition: service_healthy

    # Create service with Nginx.
    nginx:
        image: nginx:1.29.5-alpine3.23
        ports:
         - "80:80"
        depends_on:
          url-shortener-prod:
            condition: service_healthy
        volumes:
         - ./../static:/usr/share/nginx/html:ro
         - ./../configs/nginx.conf:/etc/nginx/nginx.conf:ro
